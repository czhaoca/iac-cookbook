#cloud-config
# ============================================================================
# Basic Ubuntu Hardening — Cloud-Init Template
# ============================================================================
# This template:
# - Creates a new admin user with SSH key-only access
# - Disables the default 'ubuntu' user login
# - Disables password-based SSH authentication
# - Enables automatic security updates
# - Sets up basic firewall (UFW)
#
# Variables (replaced by reprovision-vm.sh at runtime):
#   __NEW_USERNAME__     — new admin username
#   __NEW_PASSWORD_HASH__ — hashed password for sudo
#   __SSH_PUBLIC_KEY__   — SSH public key content
# ============================================================================

users:
  - name: __NEW_USERNAME__
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    lock_passwd: false
    passwd: __NEW_PASSWORD_HASH__
    ssh_authorized_keys:
      - __SSH_PUBLIC_KEY__

# Disable the default ubuntu user
runcmd:
  # Lock the ubuntu user account
  - usermod -L ubuntu 2>/dev/null || true
  - usermod -s /usr/sbin/nologin ubuntu 2>/dev/null || true

  # Harden SSH configuration
  - sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
  - sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
  - sed -i 's/^#\?ChallengeResponseAuthentication.*/ChallengeResponseAuthentication no/' /etc/ssh/sshd_config
  - sed -i 's/^#\?UsePAM.*/UsePAM no/' /etc/ssh/sshd_config
  - systemctl restart sshd

  # Enable and configure UFW
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp
  - ufw --force enable

  # Auto security updates
  - apt-get update -y
  - apt-get upgrade -y
  - apt-get install -y unattended-upgrades
  - dpkg-reconfigure -plow unattended-upgrades

package_update: true
package_upgrade: true
packages:
  - curl
  - wget
  - vim
  - htop
  - unattended-upgrades
