#cloud-config
# ============================================================================
# CloudPanel + Ubuntu Hardening — Cloud-Init Template (OCI)
# ============================================================================
# This template:
# - Creates a new admin user with SSH key-only access
# - Disables the default 'ubuntu' user login
# - Disables password-based SSH authentication
# - Installs CloudPanel via official OCI installer with checksum verification
# - Configures firewall for CloudPanel ports (8443) + SSH (22) + HTTP/HTTPS
# - Enables automatic security updates
# - Reboots after installation (required by CloudPanel)
#
# Variables (replaced by reprovision-vm.sh at runtime):
#   __NEW_USERNAME__         — new admin username
#   __NEW_PASSWORD_HASH__    — hashed password for sudo
#   __SSH_PUBLIC_KEY__       — SSH public key content
#   __CLOUDPANEL_DB_ENGINE__ — database engine (default: MYSQL_8.4)
#
# CloudPanel Requirements:
# - Ubuntu 24.04 or 22.04 (x86_64 or ARM64)
# - Minimum 1 GB RAM, 10 GB disk
# - Fresh OS installation (no existing web server)
#
# Ref: https://www.cloudpanel.io/docs/v2/getting-started/oracle-cloud/installation/installer/
# ============================================================================

users:
  - name: __NEW_USERNAME__
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    lock_passwd: false
    passwd: __NEW_PASSWORD_HASH__
    ssh_authorized_keys:
      - __SSH_PUBLIC_KEY__

runcmd:
  # Lock the ubuntu user account
  - usermod -L ubuntu 2>/dev/null || true
  - usermod -s /usr/sbin/nologin ubuntu 2>/dev/null || true

  # Harden SSH configuration
  - sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
  - sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
  - sed -i 's/^#\?ChallengeResponseAuthentication.*/ChallengeResponseAuthentication no/' /etc/ssh/sshd_config
  - sed -i 's/^#\?UsePAM.*/UsePAM no/' /etc/ssh/sshd_config
  - systemctl restart sshd

  # Configure firewall for CloudPanel
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp     # SSH
  - ufw allow 80/tcp     # HTTP
  - ufw allow 443/tcp    # HTTPS
  - ufw allow 8443/tcp   # CloudPanel admin
  - ufw --force enable

  # Install CloudPanel — official OCI installer with checksum verification
  # Ref: https://www.cloudpanel.io/docs/v2/getting-started/oracle-cloud/installation/installer/
  - apt-get update -y
  - apt-get upgrade -y
  - apt-get install -y curl wget sudo cron
  - curl -sS https://installer.cloudpanel.io/ce/v2/install.sh -o /tmp/install.sh
  - echo "19cfa702e7936a79e47812ff57d9859175ea902c62a68b2c15ccd1ebaf36caeb /tmp/install.sh" | sha256sum -c
  - CLOUD=oci DB_ENGINE=__CLOUDPANEL_DB_ENGINE__ bash /tmp/install.sh

  # Auto security updates
  - apt-get install -y unattended-upgrades
  - dpkg-reconfigure -plow unattended-upgrades

  # Reboot (required by CloudPanel after installation)
  - reboot

package_update: true
package_upgrade: true
packages:
  - curl
  - wget
  - vim
  - htop
  - cron
  - unattended-upgrades
