#cloud-config
# ============================================================================
# CloudPanel + Ubuntu Hardening — Cloud-Init Template
# ============================================================================
# This template:
# - Creates a new admin user with SSH key-only access
# - Disables the default 'ubuntu' user login
# - Disables password-based SSH authentication
# - Installs CloudPanel (https://www.cloudpanel.io/)
# - Configures firewall for CloudPanel ports (8443) + SSH (22) + HTTP/HTTPS
# - Enables automatic security updates
#
# Variables (replaced by reprovision-vm.sh at runtime):
#   __NEW_USERNAME__       — new admin username
#   __NEW_PASSWORD_HASH__  — hashed password for sudo
#   __SSH_PUBLIC_KEY__     — SSH public key content
#   __CLOUDPANEL_DB_PASS__ — CloudPanel database password (optional)
#
# CloudPanel Requirements:
# - Ubuntu 22.04 or 24.04 (x86_64 or ARM64)
# - Minimum 1 GB RAM, 10 GB disk
# - Fresh OS installation (no existing web server)
# ============================================================================

users:
  - name: __NEW_USERNAME__
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    lock_passwd: false
    passwd: __NEW_PASSWORD_HASH__
    ssh_authorized_keys:
      - __SSH_PUBLIC_KEY__

runcmd:
  # Lock the ubuntu user account
  - usermod -L ubuntu 2>/dev/null || true
  - usermod -s /usr/sbin/nologin ubuntu 2>/dev/null || true

  # Harden SSH configuration
  - sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
  - sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
  - sed -i 's/^#\?ChallengeResponseAuthentication.*/ChallengeResponseAuthentication no/' /etc/ssh/sshd_config
  - sed -i 's/^#\?UsePAM.*/UsePAM no/' /etc/ssh/sshd_config
  - systemctl restart sshd

  # Configure firewall for CloudPanel
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp     # SSH
  - ufw allow 80/tcp     # HTTP
  - ufw allow 443/tcp    # HTTPS
  - ufw allow 8443/tcp   # CloudPanel admin
  - ufw --force enable

  # Install CloudPanel
  # Official installer: https://www.cloudpanel.io/docs/v2/getting-started/
  - apt-get update -y
  - apt-get upgrade -y
  - curl -sSL https://installer.cloudpanel.io/ce/v2/install.sh -o /tmp/cloudpanel-install.sh
  - bash /tmp/cloudpanel-install.sh

  # Auto security updates
  - apt-get install -y unattended-upgrades
  - dpkg-reconfigure -plow unattended-upgrades

package_update: true
package_upgrade: true
packages:
  - curl
  - wget
  - vim
  - htop
  - unattended-upgrades
